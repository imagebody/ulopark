# -*- coding: utf-8 -*-

import os
import pandas as pd
import myconfig
from cPickle import dump, load

portfolio_hist_k_map = {
	
}



symbols = [ 
['sh601607', 'sz300077', 'sz300070', 'sh600418', 'sz002393', 'sz300072', 'sz000582', 'sz002202', 'sz002387', 'sz300076', 'sz300059', 'sz300075', 'sz002372', 'sz002344', 'sz300078', 'sz002367', 'sz300073', 'sz300050', 'sz002384', 'sz002357', 'sz002366', 'sz300069', 'sz300071', 'sh600684', 'sh600648', 'sh600480', 'sh601369', 'sz002385', 'sz002389', 'sz002388', 'sh600166', 'sz300049', 'sh600649', 'sz002358', 'sz002369', 'sz002336', 'sz300066', 'sh600528', 'sz002070', 'sz002368', 'sz000635', 'sh601390', 'sz300048', 'sh601101', 'sz002379', 'sz002085', 'sz002395', 'sz000157', 'sz000800', 'sz002378', 'sz002340', 'sz000001', 'sz300058', 'sz002098', 'sz002345', 'sz002391', 'sh600317', 'sz002371', 'sz300074', 'sz300062', 'sz002392', 'sz002377', 'sz000708', 'sz300046', 'sh600383', 'sz002355', 'sz002335', 'sh601877', 'sz300047']
, 
['sz002336', 'sz002345', 'sh600823', 'sz002384', 'sz300056', 'sz002067', 'sh601009', 'sh600362', 'sh600967', 'sh600704', 'sz002358', 'sh600184', 'sz002142', 'sz002237', 'sh601169', 'sz000965', 'sh600717', 'sz000635', 'sh600684', 'sz002155', 'sh600280', 'sz002344', 'sz000998', 'sh600386', 'sh600577', 'sz000418', 'sh600036', 'sh600778', 'sh601006', 'sz002097', 'sh600841', 'sz002147', 'sh600428', 'sz000596', 'sz002083', 'sz000419', 'sh600183', 'sh601328', 'sz002069', 'sz000582', 'sz002026', 'sh600303', 'sz002378', 'sh600673', 'sh600190', 'sz002158']
, 
['sz002234', 'sh600636', 'sh600549', 'sh600160', 'sz002110', 'sh601186', 'sz000970', 'sz000635', 'sh600366', 'sz000060', 'sh600823', 'sz000159', 'sh600067', 'sz000666', 'sh600694', 'sh600748', 'sh600117', 'sh600547', 'sz000960', 'sz000402', 'sh600176', 'sh600489', 'sh600585', 'sh600058', 'sh600546', 'sz000422', 'sh600729', 'sz000596', 'sz002206', 'sh600060', 'sz002318', 'sh600219', 'sh600704', 'sh600563', 'sh600469', 'sh600664', 'sz000731', 'sh600031', 'sz002091', 'sh600375', 'sh600612', 'sz002458', 'sz002109', 'sz000630', 'sz002238', 'sh601001', 'sh600295', 'sh600309', 'sz000905', 'sz000655']
, 
['sz300192', 'sz002458', 'sz002574', 'sz002407', 'sz002554', 'sh601199', 'sz002273', 'sz300195', 'sz002573', 'sz002570', 'sz002569', 'sz002398', 'sz002559', 'sz002092', 'sz300209', 'sz000596', 'sz300193', 'sz002371', 'sz002564', 'sz000422', 'sz300190', 'sz002563', 'sz300160', 'sz300207', 'sh601799', 'sz002565', 'sz002237', 'sz002541', 'sz300046', 'sh601216', 'sh601011', 'sz300191', 'sh600823', 'sz002558', 'sz002572', 'sz300048', 'sz300196', 'sz002578', 'sz300200', 'sz002567', 'sz002553', 'sz300049', 'sz002544', 'sz300163', 'sz002539', 'sz002546', 'sz300169', 'sz002576', 'sz300180', 'sz300199', 'sz300186', 'sz002538', 'sz300047', 'sz300171', 'sz300182', 'sz300177', 'sz300210', 'sz300102', 'sz300206', 'sz002566', 'sz002422', 'sz300164', 'sh600967', 'sh600362', 'sz002568', 'sh600461', 'sz002408', 'sz300189', 'sz300183', 'sz300168', 'sz002345', 'sz002477', 'sz300170', 'sz300082', 'sz300174', 'sz002540', 'sz300080', 'sz000001', 'sz002552', 'sz002126', 'sz002406', 'sz300184', 'sz300208', 'sz002560', 'sz002575', 'sz300070', 'sh601137', 'sz002367', 'sz300181', 'sz002421', 'sz002550', 'sz300194', 'sz300066', 'sz002410', 'sz002543', 'sz002545', 'sz002577']
, 
['sh600694', 'sh600452', 'sh600552', 'sh600723', 'sz000970', 'sz000799', 'sz000563', 'sz000598', 'sz002029', 'sh600858', 'sz002313', 'sz000400', 'sz000921', 'sz002298', 'sz000544', 'sz002033', 'sh600038', 'sh600785', 'sh601717', 'sz300002', 'sh600729', 'sz000078', 'sz000417', 'sz300041', 'sz000823', 'sz300028', 'sz000596', 'sz002101', 'sh600657', 'sz000501', 'sz002277', 'sz000042', 'sh600495', 'sh600559', 'sz002144', 'sz002269', 'sz300019', 'sz300018', 'sh601888', 'sz002326', 'sz002154', 'sh600859', 'sh600590', 'sh600143', 'sz002294', 'sz000759', 'sz002297', 'sz300113', 'sz300039', 'sh600967', 'sz002242', 'sh600469', 'sz002365', 'sh600467', 'sz000797', 'sz000521', 'sh601718', 'sh600000', 'sz002345', 'sz000157', 'sh600518', 'sz000738', 'sz002344']
, 
['sh600452', 'sh600397', 'sz300031', 'sz300128', 'sh600694', 'sz000799', 'sz002521', 'sz300132', 'sz002535', 'sz000563', 'sh600495', 'sz000552', 'sz002496', 'sz002029', 'sh600723', 'sz002531', 'sz300055', 'sz002450', 'sz000524', 'sz002532', 'sh600482', 'sh600778', 'sh600157', 'sh600007', 'sz300099', 'sz300155', 'sz300176', 'sz002322', 'sh600481', 'sz000070', 'sz000078', 'sz000400', 'sz002033', 'sh600859', 'sz002534', 'sz300002', 'sh600552', 'sz000598', 'sz300157', 'sz300141', 'sz000564', 'sz300273', 'sh600785', 'sz002516', 'sz300014', 'sh600702', 'sz300048', 'sz300156', 'sz002313', 'sh600729']
, 
['sh600694', 'sz002304', 'sh600702', 'sz000799', 'sh600778', 'sz000719', 'sz002033', 'sh600723', 'sz002154', 'sh600007', 'sh600519', 'sh603001', 'sh600891', 'sh601369', 'sh600482', 'sz000552', 'sz000596', 'sh600699', 'sz000524', 'sh600827', 'sz002656', 'sh603000', 'sz000861', 'sz002277', 'sz002293', 'sz002535', 'sh600967', 'sz000705', 'sh601929', 'sz002662', 'sz002327', 'sh600785', 'sh600575', 'sh600322', 'sz002085', 'sz002667', 'sh600729', 'sh600697', 'sz002153', 'sz000501', 'sz002534', 'sh600172', 'sh600068', 'sz000070', 'sz002664', 'sz000823', 'sz000920', 'sh600495', 'sz002086', 'sh601116']
, 
['sz000895', 'sh600011', 'sh600532', 'sz002304', 'sz002469', 'sz000957', 'sz000883', 'sz002628', 'sz002033', 'sz002535', 'sh600452', 'sz002276', 'sz000722', 'sh600197', 'sh600172', 'sz000301', 'sh600623', 'sh600098', 'sz000719', 'sz002228', 'sz300129', 'sh600859', 'sz002443', 'sz002511', 'sz000869', 'sz002646', 'sh600199', 'sz002615', 'sz000596', 'sh600858', 'sz002251', 'sh600697', 'sz000601', 'sz002327', 'sh601126', 'sz002360', 'sz002142', 'sz002086', 'sz000568', 'sh600513', 'sh600729', 'sz002612', 'sh600694', 'sh600738', 'sz002419', 'sz002293', 'sh601789', 'sh600398', 'sh601000', 'sh600519']
, 
['sz000895', 'sh600011', 'sh600532', 'sz002304', 'sz002469', 'sz000957', 'sz000883', 'sz002628', 'sz002033', 'sz002535', 'sh600452', 'sz002276', 'sz000722', 'sh600197', 'sh600172', 'sz000301', 'sh600623', 'sh600098', 'sz000719', 'sz002228', 'sz300129', 'sh600859', 'sz002443', 'sz002511', 'sz000869', 'sz002646', 'sh600199', 'sz002615', 'sz000596', 'sh600858', 'sz002251', 'sh600697', 'sz000601', 'sz002327', 'sh601126', 'sz002360', 'sz002142', 'sz002086', 'sz000568', 'sh600513', 'sh600729', 'sz002612', 'sh600694', 'sh600738', 'sz002419', 'sz002293', 'sh601789', 'sh600398', 'sh601000', 'sh600519']
, 
['sh601901', 'sh600093', 'sz001896', 'sz000553', 'sz002258', 'sh600780', 'sz000024', 'sz000029', 'sh601818', 'sh600641', 'sz000552', 'sz000961', 'sz002503', 'sh600697', 'sz002663', 'sz000046', 'sz002450', 'sz002142', 'sz000796', 'sz000584', 'sh600803', 'sz002496', 'sz000816', 'sh600694', 'sz002324', 'sz000690', 'sh600172', 'sz000895', 'sz000539', 'sz002013', 'sh600886', 'sh600011', 'sz000883', 'sh600583', 'sh600222', 'sh601888', 'sh601933', 'sz002322', 'sz002456', 'sz000525', 'sh600313', 'sh600050', 'sh600266', 'sz002100', 'sz000601', 'sz002028', 'sh600187', 'sh600098', 'sz000090', 'sh600438', 'sh600132', 'sz000790', 'sh600177', 'sh600510', 'sz000402', 'sh601991', 'sh600795', 'sz002084', 'sh600481', 'sz002227', 'sh600292', 'sz002061', 'sz000750']
, 
['sz000860', 'sh600138', 'sz002353', 'sh600887', 'sz002375', 'sz000531', 'sh600292', 'sz300355', 'sh600305', 'sz002051', 'sz000600', 'sh600518', 'sh600510', 'sh600332', 'sh600116', 'sh600352', 'sh600801', 'sh600218', 'sz002271', 'sh603993', 'sz000820', 'sh600337', 'sz002547', 'sz002236', 'sh600248', 'sz000789', 'sh600389', 'sz000929', 'sz002590', 'sh600583']
]


portfolio_list = [
    ['2011-05-01', '2011-09-01', symbols[0]],
    ['2011-09-02', '2011-11-01', symbols[1]],
    ['2011-11-02', '2012-05-01', symbols[2]],
    ['2012-05-02', '2012-09-01', symbols[3]],
    ['2012-09-02', '2012-11-01', symbols[4]],
    ['2012-11-02', '2013-05-01', symbols[5]],
    ['2013-05-02', '2013-09-01', symbols[6]],
    ['2013-09-02', '2013-11-01', symbols[7]],
    ['2013-11-02', '2014-05-01', symbols[8]],
    ['2014-05-02', '2014-09-01', symbols[9]],
    ['2014-09-02', '2014-11-01', symbols[10]]
]


def get_stock_hist_df(stock_cd):
	# stock_cd format sh000300, day format 2011-05-01
	file = myconfig.stock_data_path + u'/' + stock_cd + u'.csv'

	df = pd.read_csv(file)
	df_filtered = df.sort(['date']).reset_index()
	#print df
	return df_filtered



def get_portfolio_map():
	filename = 'portfolio_hist_k_map.pkl'
	pmap = {}
	if os.path.isfile(filename):
		pmap = load( open(filename, 'rb') )
	else:
		print 'load again'
		for l in symbols:
			for s in l:
				if s not in pmap:
					pmap[s] = get_stock_hist_df(s)
		dump( pmap, open(filename, 'wb') )
			#count += 1
			#if count > 5:
			#	return
	return pmap



def get_stock_list(date):
	# date format 2015-01-01
	for item in portfolio_list:
		if date >= item[0] and date <= item[1]:
			return item[2]
	print 'error, can not find portfolio_list'
	return None

def get_stock_list1(date):
	# date 2015-01-01
	if date>='2011-05-01' and date<='2011-08-31':
		return ['sh601607','sh300077']
	elif date>='2011-09-01' and date<='2011-10-31':
		return ['sh002336','sh002345']
	elif date>='2011-05-01' and date<='2011-08-31':
		return ['sh601607','sh300077']
	elif date>='2011-05-01' and date<='2011-08-31':
		return ['sh601607','sh300077']
	elif date>='2011-05-01' and date<='2011-08-31':
		return ['sh601607','sh300077']

	return ['sh000300']


def test1():
	print get_stock_list('2011-04-01')
	if 'sh000300' in get_stock_list('2011-04-30'):
		print 'in'
	print get_stock_list('2011-05-01')
	print get_stock_list('2011-08-31')
	print get_stock_list('2011-09-01')
	print get_stock_list('2011-10-01')

def test2():
	print portfolio
	print portfolio['sh000001']['last_nv']

def test3():
	print portfolio_hist_k_map['sz300077'][:5]

def test4():
	print get_stock_list('2011-05-01')
	print get_stock_list('2015-05-01')
	print get_stock_list('2014-05-01')

def test5():
	df = pd.DataFrame(symbols)
	print df


portfolio_hist_k_map = get_portfolio_map()

if __name__ == '__main__':
	test3()

